@page "/"
@page "/menu"
@using System.Globalization
@using Database.Model
@using Contract.Model.Requests
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Men√º der Woche</PageTitle>

<div class="menu-page">
    <div class="menu-banner">
        <div class="brand">
            <div class="brand-icon" aria-hidden="true">üê¨</div>
            <div>
                <div class="brand-kicker">komb√ºse</div>
                <div class="brand-title">W√∂chentlicher Speiseplan</div>
            </div>
        </div>
        <div class="week-meta">
            <div class="week-label">Woche</div>
            <div class="week-range">@weekStart.ToString("dd.MM.yyyy") - @weekEnd.ToString("dd.MM.yyyy")</div>
        </div>
    </div>

    <div class="menu-card">
        @if (isLoading)
        {
            <div class="loading">Men√º wird geladen...</div>
        }
        else if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="error">@errorMessage</div>
        }
        else
        {
            <div class="menu-grid">
                <div class="grid-header option-header">Option</div>
                @foreach (var day in WeekDays)
                {
                    <div class="grid-header @(IsToday(day) ? "today" : string.Empty)">
                        <div class="day-name">@FormatDayName(day)</div>
                        <div class="day-date">@day.ToString("dd.MM")</div>
                    </div>
                }

                @foreach (var option in mealOptions)
                {
                    <div class="option-title">@FormatOption(option)</div>

                    @foreach (var day in WeekDays)
                    {
                        var meal = GetMeal(day, option);
                        <div class="meal-cell @(IsToday(day) ? "today" : string.Empty)">
                            @if (meal is not null)
                            {
                                <div class="meal-description">@meal.Description</div>

                                @if (mealMessages.TryGetValue(meal.Id, out var message) && !string.IsNullOrWhiteSpace(message))
                                {
                                    <div class="cell-note">@message</div>
                                }

                                <div class="meal-actions">
                                    @if (IsEditing(meal.Id))
                                    {
                                        <div class="rename-row">
                                            <input class="rename-input" @bind="renameDraft[meal.Id]" placeholder="Neuer Name" />
                                            <button class="action-button" @onclick="() => SaveRenameAsync(meal)">Speichern</button>
                                            <button class="link-button" @onclick="() => CancelEdit(meal.Id)">Abbrechen</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="link-button" @onclick="() => StartEdit(meal)">üñä‚Ää umbenennen</button>
                                    }

                                    <div class="rating-row">
                                        <span>Bewerten:</span>
                                        <div class="stars">
                                            @for (int star = 1; star <= 5; star++)
                                            {
                                                var isDisabled = !IsToday(meal.Date);
                                                <button class="star-button" disabled="@isDisabled" title="@(isDisabled ? "Bewertung nur am jeweiligen Tag m√∂glich" : $"{star} Sterne geben")" @onclick="() => RateMealAsync(meal, star)">
                                                    @(isDisabled ? "‚òÜ" : "‚òÖ")
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="meal-empty">Noch kein Gericht eingetragen.</div>
                            }
                        </div>
                    }
                }
            </div>
        }
    </div>
</div>

@code {
    private readonly MealOption[] mealOptions = Enum.GetValues<MealOption>();
    private List<DailyMeal> weeklyMeals = new();
    private readonly Dictionary<int, string> renameDraft = new();
    private readonly HashSet<int> editingMeals = new();
    private readonly Dictionary<int, string> mealMessages = new();

    private bool isLoading = true;
    private string? errorMessage;
    private DateOnly weekStart = GetCurrentWeekStart();
    private DateOnly weekEnd => weekStart.AddDays(4);

    private IEnumerable<DateOnly> WeekDays => Enumerable.Range(0, 5).Select(i => weekStart.AddDays(i));

    protected override async Task OnInitializedAsync()
    {
        await LoadMenusAsync();
    }

    private async Task LoadMenusAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var menus = await client.GetFromJsonAsync<List<DailyMeal>>("api/menu/week");
            weeklyMeals = menus ?? new List<DailyMeal>();

            if (weeklyMeals.Count > 0)
            {
                var minDate = weeklyMeals.Min(m => m.Date);
                weekStart = GetWeekStart(minDate);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Men√º konnte nicht geladen werden: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private DailyMeal? GetMeal(DateOnly day, MealOption option)
        => weeklyMeals.FirstOrDefault(m => m.Date == day && m.Option == option);

    private static DateOnly GetCurrentWeekStart() => GetWeekStart(DateOnly.FromDateTime(DateTime.UtcNow.Date));

    private static DateOnly GetWeekStart(DateOnly date)
    {
        int day = (int)date.DayOfWeek;
        day = day == 0 ? 7 : day;
        return date.AddDays(-(day - 1));
    }

    private string FormatDayName(DateOnly date)
    {
        var culture = CultureInfo.GetCultureInfo("de-DE");
        return culture.DateTimeFormat.GetDayName(date.ToDateTime(TimeOnly.MinValue).DayOfWeek);
    }

    private static string FormatOption(MealOption option) => option switch
    {
        MealOption.Grill_Sandwiches => "Grill Sandwiches",
        MealOption.Smuts_Leibspeise => "Smuts Leibspeise",
        MealOption.Just_Good_Food => "Just Good Food",
        _ => option.ToString()
    };

    private bool IsToday(DateOnly date) => date == DateOnly.FromDateTime(DateTime.UtcNow.Date);

    private bool IsEditing(int mealId) => editingMeals.Contains(mealId);

    private void StartEdit(DailyMeal meal)
    {
        editingMeals.Add(meal.Id);
        renameDraft[meal.Id] = meal.Description;
    }

    private void CancelEdit(int mealId)
    {
        editingMeals.Remove(mealId);
        renameDraft.Remove(mealId);
        mealMessages.Remove(mealId);
    }

    private async Task SaveRenameAsync(DailyMeal meal)
    {
        if (!renameDraft.TryGetValue(meal.Id, out var newName) || string.IsNullOrWhiteSpace(newName))
        {
            mealMessages[meal.Id] = "Bitte einen g√ºltigen Namen eingeben.";
            return;
        }

        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var request = new RenameMenuRequest(meal.Id, newName.Trim());
            var response = await client.PostAsJsonAsync("api/menu/rename", request);

            if (response.IsSuccessStatusCode)
            {
                meal.Description = newName.Trim();
                editingMeals.Remove(meal.Id);
                mealMessages[meal.Id] = "Umbenannt.";
            }
            else
            {
                var serverMessage = await response.Content.ReadAsStringAsync();
                mealMessages[meal.Id] = string.IsNullOrWhiteSpace(serverMessage) ? "Umbenennen fehlgeschlagen." : serverMessage;
            }
        }
        catch (Exception ex)
        {
            mealMessages[meal.Id] = $"Fehler: {ex.Message}";
        }
    }

    private async Task RateMealAsync(DailyMeal meal, int stars)
    {
        if (!IsToday(meal.Date))
        {
            mealMessages[meal.Id] = "Bewertungen sind nur am jeweiligen Tag m√∂glich.";
            return;
        }

        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var request = new RateMealRequest(meal.Id, stars);
            var response = await client.PostAsJsonAsync("api/ratings/rate", request);

            mealMessages[meal.Id] = response.IsSuccessStatusCode
                ? $"Danke f√ºr {stars} Sterne!"
                : "Bewertung konnte nicht gespeichert werden.";
        }
        catch (Exception ex)
        {
            mealMessages[meal.Id] = $"Fehler: {ex.Message}";
        }
    }
}
