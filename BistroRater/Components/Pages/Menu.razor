@page "/"
@page "/menu"
@rendermode RenderMode.InteractiveServer
@using System.Globalization
@using Database.Model
@using Contract.Model.Requests
@using static Database.Model.DailyMeal
@inject IHttpClientFactory HttpClientFactory
@inject AuthenticationStateProvider AuthState

<PageTitle>Men√º der Woche</PageTitle>

<div class="menu-page">
    <div class="menu-banner">
        <div class="brand">
            <div class="brand-icon" aria-hidden="true">üê¨</div>
            <div>
                <div class="brand-kicker">Komb√ºse</div>
                <div class="brand-title">W√∂chentlicher Speiseplan</div>
            </div>
        </div>
        <div class="week-meta">
            <div class="week-label">Woche</div>
            <div class="week-range">@weekStart.ToString("dd.MM.yyyy") - @weekEnd.ToString("dd.MM.yyyy")</div>
        </div>
        <button class="top-button" @onclick="OpenTopModalAsync">Top 10 Gerichte</button>
    </div>

    <div class="menu-card">
        @if (isLoading)
        {
            <div class="loading">Men√º wird geladen...</div>
        }
        else if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="error">@errorMessage</div>
        }
        else
        {
            <div class="menu-grid">
                <div class="grid-header option-header">Option</div>
                @foreach (var day in WeekDays)
                {
                    <div class="grid-header @(IsToday(day) ? "today" : string.Empty)">
                        <div class="day-name">@FormatDayName(day)</div>
                        <div class="day-date">@day.ToString("dd.MM")</div>
                    </div>
                }

                @foreach (var option in mealOptions)
                {
                    <div class="option-title">@FormatOption(option)</div>

                    @foreach (var day in WeekDays)
                    {
                        var meal = GetMeal(day, option);
                        <div class="meal-cell @(IsToday(day) ? "today" : string.Empty)">
                            @if (meal is not null)
                            {
                                <div class="meal-description">@meal.Description</div>

                                @if (mealMessages.TryGetValue(meal.Id, out var message) && !string.IsNullOrWhiteSpace(message))
                                {
                                    <div class="cell-note">@message</div>
                                }

                                <div class="meal-actions">
                                    @if (IsEditing(meal.Id))
                                    {
                                        <div class="rename-row">
                                            <input class="rename-input"
                                                   value="@renameDraft[meal.Id]"
                                                   @oninput="(e => OnRenameInput(meal.Id, e.Value?.ToString() ?? string.Empty))"
                                                   placeholder="Neuer Name" />

                                            @if (ActiveSuggestions.TryGetValue(meal.Id, out var list) && list.Any())
                                            {
                                                <ul class="autocomplete-list">
                                                    @foreach (var s in list)
                                                    {
                                                        <li @onclick="() => SelectSuggestion(meal.Id, s)">@s</li>
                                                    }
                                                </ul>
                                            }
                                            <button class="action-button" @onclick="() => SaveRenameAsync(meal)">Speichern</button>
                                            <button class="link-button" @onclick="() => CancelEdit(meal.Id)">Abbrechen</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <button class="link-button" @onclick="() => StartEdit(meal)">üñä‚Ää umbenennen</button>
                                    }

                                    <div class="rating-row">
                                        <span>Bewerten:</span>
                                        <div class="stars">
                                            @foreach (int star in Enumerable.Range(1,5))
                                            {
                                                var isDisabled = !IsToday(meal.DayNumber);
                                                <button class="star-button" disabled="@isDisabled" title="@(isDisabled ? "Bewertung nur am jeweiligen Tag m√∂glich" : $"{star} Sterne geben")" @onclick="() => RateMealAsync(meal, star)">
                                                    @(isDisabled ? "‚òÜ" : "‚òÖ")
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="meal-empty">Noch kein Gericht eingetragen.</div>
                            }
                        </div>
                    }
                }
            </div>
        }
    </div>
</div>

@if (isTopModalOpen)
{
    <div class="modal-backdrop" @onclick="CloseTopModal">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Top 10 Daily Men√ºs</h3>
                <button class="close-button" @onclick="CloseTopModal" aria-label="Schlie√üen">√ó</button>
            </div>
            <div class="modal-body">
                @if (isTopLoading)
                {
                    <div class="loading">Top-Liste wird geladen...</div>
                }
                else if (!string.IsNullOrWhiteSpace(topErrorMessage))
                {
                    <div class="error">@topErrorMessage</div>
                }
                else if (!topMenus.Any())
                {
                    <div class="empty">Noch keine Bewertungen vorhanden.</div>
                }
                else
                {
                    <ol class="top-list">
                        @foreach (var menu in topMenus)
                        {
                            <li>
                                <div class="top-item">
                                    <div class="top-title">@menu.Description</div>
                                    <div class="top-meta">
                                        <span class="top-stars">‚≠ê @menu.AvgStars.ToString("0.0")</span>
                                        <span class="top-count">@menu.Count Bewertungen</span>
                                    </div>
                                </div>
                            </li>
                        }
                    </ol>
                }
            </div>
        </div>
    </div>
}
